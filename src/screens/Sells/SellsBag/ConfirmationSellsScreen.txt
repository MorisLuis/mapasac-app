import React, { useCallback, useContext, useEffect, useState } from 'react';
import { SafeAreaView, Text, TouchableOpacity, View, FlatList } from 'react-native';
import { buttonStyles } from '../../../theme/UI/buttons';
import { ConfirmationScreenStyles } from '../../../theme/ConfirmationScreenTheme';
import { useTheme } from '../../../context/ThemeContext';
import { useNavigation, useFocusEffect, RouteProp } from '@react-navigation/native';
import DotLoader from '../../../components/Ui/DotLaoder';
import { getBagInventory, getTotalPriceBag } from '../../../services/bag';
import { ConfirmationSkeleton } from '../../../components/Skeletons/ConfirmationSkeleton';
import Toast from 'react-native-toast-message';
import { SellsBagContext } from '../../../context/Sells/SellsBagContext';
import { ProductSellsInterface, ProductSellsInterfaceBag } from '../../../interface/productSells';
import { ProductSellsConfirmationCard } from '../../../components/Cards/ProductSellsConfirmationCard';
import { postSells, postSellsInterface } from '../../../services/sells';
import { format } from '../../../utils/currency';
import { useProtectPage } from '../../../hooks/useProtectPage';
import Icon from 'react-native-vector-icons/Ionicons';
import { globalFont, globalStyles } from '../../../theme/appTheme';
import { TextInputContainer } from '../../../components/Ui/TextInputContainer';
import { selectStyles } from '../../../theme/UI/inputs';
import ClientInterface from '../../../interface/utils';
import { CombinedSellsAndAppNavigationStackParamList } from '../../../navigator/AppNavigation';
import { NativeStackNavigationProp } from '@react-navigation/native-stack';
import { SellsNavigationStackParamList } from '../../../navigator/SellsNavigation';

type ConfirmationSellsScreenRouteProp = RouteProp<SellsNavigationStackParamList, '[Sells] - confirmationScreen'>;

interface ConfirmationSellsScreenInterface {
    route: ConfirmationSellsScreenRouteProp;
}

export const ConfirmationSellsScreen = ({ route }: ConfirmationSellsScreenInterface) => {

    const { client } = route?.params ?? {};
    const { numberOfItemsSells, resetAfterPost } = useContext(SellsBagContext);
    const { typeTheme, theme } = useTheme();
    const { navigate } = useNavigation<NativeStackNavigationProp<CombinedSellsAndAppNavigationStackParamList>>();
    const iconColor = typeTheme === 'light' ? theme.text_color : theme.text_color_secondary;

    const [createSellLoading, setCreateSellLoading] = useState(false);
    const [page, setPage] = useState(1);
    const [bags, setBags] = useState<ProductSellsInterfaceBag[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [hasMore, setHasMore] = useState(true);
    const [dataUploaded, setDataUploaded] = useState(false);
    const [totalPrice, setTotalPrice] = useState<number>();
    const [methodPayment, setMethodPayment] = useState(0);
    const [typeSelected, setTypeSelected] = useState<ClientInterface>();
    const [comments, setComments] = useState("");
    const [openConfirmationInfo, setOpenConfirmationInfo] = useState(true);
    const availableToPost = methodPayment !== 0;
    const disabledToPost = methodPayment === 1 && !typeSelected;

    const renderItem = useCallback(({ item }: { item: ProductSellsInterface }) => (
        <ProductSellsConfirmationCard
            product={item}
            onClick={() => navigate('[Modal] - editProductSellInBag', { product: item })}
            disabled={createSellLoading}
        />
    ), [createSellLoading, bags]);

    const onPostInventory = async () => {
        setCreateSellLoading(true);
        try {
            const sellBody: postSellsInterface = {
                clavepago: methodPayment,
                idclientes: typeSelected?.idclientes,
                comments
            }
            await postSells(sellBody);
            setTimeout(() => {
                navigate('succesMessageScreen', { message: 'Se ha generado con exito su pedido.', redirection: 'SellsNavigation' });
                resetAfterPost();
            }, 500);

            setTimeout(() => {
                setCreateSellLoading(false);
            }, 750);
        } catch (error: any) {
            Toast.show({
                type: 'tomatoError',
                text1: 'Hubo un error, asegurate de tener conexiÃ³n a internet.'
            })
            setCreateSellLoading(false);
            console.log("Error al crear inventario:", error);
        }
    };

    const loadBags = async () => {
        if (isLoading || !hasMore) return;
        setIsLoading(true);
        const newBags = await getBagInventory({ page, limit: 5, option: 2, mercado: true });

        if (newBags && newBags.length > 0) {
            setBags((prevBags: ProductSellsInterfaceBag[]) => [...prevBags, ...newBags]);
            setPage(page + 1);
        } else {
            setHasMore(false);
        }

        setIsLoading(false);
    };

    const handleGetPrice = async () => {
        const totalprice: string = await getTotalPriceBag({ opcion: 2, mercado: true });
        setTotalPrice(parseFloat(totalprice))
    }

    const handleGetClient = () => {
        setTypeSelected(client)
    }

    const renderScreen = () => {

        return (
            <View style={ConfirmationScreenStyles(theme, typeTheme).confirmationSells}>
                <View style={ConfirmationScreenStyles(theme, typeTheme).confirmationInfo}>
                    <View style={ConfirmationScreenStyles(theme, typeTheme).confirmationItems}>
                        <CustomText style={ConfirmationScreenStyles(theme, typeTheme).confirmationItems_number}>{numberOfItemsSells}</CustomText>
                        <CustomText style={ConfirmationScreenStyles(theme, typeTheme).confirmationText}>Productos afectados.</CustomText>
                    </View>
                    <View
                        style={ConfirmationScreenStyles(theme, typeTheme).confirmationMovement}>
                        <CustomText style={ConfirmationScreenStyles(theme, typeTheme).confirmationText}>Tipo de movimiento:</CustomText>
                        <CustomText style={[ConfirmationScreenStyles(theme, typeTheme).confirmationText, { color: typeTheme === "light" ? theme.color_red : theme.color_tertiary }]}>Venta</CustomText>
                    </View>
                    <View
                        style={ConfirmationScreenStyles(theme, typeTheme).confirmationMovement}>
                        <CustomText style={ConfirmationScreenStyles(theme, typeTheme).confirmationText}>Total:</CustomText>
                        <CustomText style={[ConfirmationScreenStyles(theme, typeTheme).confirmationText, { color: typeTheme === "light" ? theme.color_red : theme.color_tertiary }]}>{format(totalPrice as number)}</CustomText>
                    </View>
                </View>

                <View style={ConfirmationScreenStyles(theme, typeTheme).confirmationPaymentInfo}>

                    {
                        methodPayment !== 0 &&
                        <View style={{
                            display: 'flex',
                            flexDirection: 'row',
                            justifyContent: "space-between",
                            alignItems: 'center'
                        }}>
                            {
                                !openConfirmationInfo ? <CustomText>Metodo de pago</CustomText> : <View></View>
                            }
                            <TouchableOpacity
                                onPress={() => setOpenConfirmationInfo(!openConfirmationInfo)}
                                style={{
                                    display: "flex",
                                    borderWidth: 1,
                                    backgroundColor: theme.background_color_tertiary,
                                    borderColor: theme.color_border_tertiary,
                                    padding: globalStyles(theme).globalPadding.padding / 4,
                                    borderRadius: globalStyles(theme).borderRadius.borderRadius
                                }}
                            >
                                <Icon name={openConfirmationInfo ? 'chevron-down-outline' : 'chevron-up-outline'} color={iconColor} size={globalFont.font_normal} />
                            </TouchableOpacity>
                        </View>
                    }

                    {
                        openConfirmationInfo &&
                        <>
                            <View style={ConfirmationScreenStyles(theme, typeTheme).confirmationDataHeader}>
                                <CustomText style={ConfirmationScreenStyles(theme, typeTheme).confirmationText}>Forma de pago</CustomText>
                            </View>

                            <View style={ConfirmationScreenStyles(theme, typeTheme).paymentMethodContainer}>
                                <TouchableOpacity
                                    style={methodPayment === 1 ? ConfirmationScreenStyles(theme, typeTheme).paymentMethodItemActive : ConfirmationScreenStyles(theme, typeTheme).paymentMethodItem}
                                    onPress={() => setMethodPayment(1)}
                                >
                                    <Icon name='card-outline' color={iconColor} size={globalFont.font_normal} />
                                    <CustomText>Credito</CustomText>
                                </TouchableOpacity>
                                <TouchableOpacity
                                    style={methodPayment === 2 ? ConfirmationScreenStyles(theme, typeTheme).paymentMethodItemActive : ConfirmationScreenStyles(theme, typeTheme).paymentMethodItem}
                                    onPress={() => setMethodPayment(2)}
                                >
                                    <Icon name='cash-outline' color={iconColor} size={globalFont.font_normal} />
                                    <CustomText>Contado</CustomText>
                                </TouchableOpacity>
                            </View>

                            {
                                methodPayment === 1 &&
                                <View style={ConfirmationScreenStyles(theme, typeTheme).paymentMethodClient}>
                                    <TouchableOpacity onPress={() => navigate("[Modal] - SelectClient")} style={selectStyles(theme).input}>
                                        <CustomText>{typeSelected ? typeSelected.nombres : 'Selecciona el cliente...'}</CustomText>
                                    </TouchableOpacity>
                                </View>
                            }

                            {
                                methodPayment !== 0 &&
                                <View style={ConfirmationScreenStyles(theme, typeTheme).paymentMethodClient}>
                                    <TextInputContainer label='Comentarios' setComments={setComments} value={comments} />
                                </View>
                            }
                        </>
                    }

                </View>
            </View>
        )
    }

    useFocusEffect(
        useCallback(() => {
            const refreshBags = async () => {
                setIsLoading(true);
                const refreshedBags = await getBagInventory({ page: 1, limit: 5, option: 2, mercado: true });
                setBags(refreshedBags);
                setPage(2);
                setIsLoading(false);
                setHasMore(true);
                setDataUploaded(true)
            };
            handleGetPrice();
            refreshBags();
        }, [])
    );


    useEffect(() => {
        handleGetClient();
    }, [client])


    const { protectThisPage } = useProtectPage({
        numberOfItems: numberOfItemsSells,
        loading: createSellLoading,
        navigatePage: 'SellsScreen'
    });

    return !protectThisPage ? (
        <SafeAreaView style={ConfirmationScreenStyles(theme, typeTheme).ConfirmationScreen}>
            <View style={ConfirmationScreenStyles(theme, typeTheme).ConfirmationScreenContent}>
                {
                    dataUploaded ? (
                        <FlatList
                            data={availableToPost ? bags : []}
                            renderItem={renderItem}
                            keyExtractor={product => `${product.idenlacemob}`}
                            onEndReached={loadBags}
                            onEndReachedThreshold={0.5}
                            ListHeaderComponent={
                                <>
                                    {renderScreen()}
                                    {
                                        availableToPost &&
                                        <View style={ConfirmationScreenStyles(theme, typeTheme).confirmation}>
                                            <View style={ConfirmationScreenStyles(theme, typeTheme).confirmationProductsContent}>
                                                <CustomText style={ConfirmationScreenStyles(theme, typeTheme).confirmationProductsContentHeader}>Productos</CustomText>
                                            </View>
                                        </View>

                                    }
                                </>
                            }
                        />
                    ) : (
                        <ConfirmationSkeleton />
                    )
                }
            </View>

            {
                availableToPost && (
                    <View style={ConfirmationScreenStyles(theme, typeTheme).footer}>
                        <TouchableOpacity
                            style={[buttonStyles(theme).button, buttonStyles(theme).black, disabledToPost && buttonStyles(theme).disabled]}
                            onPress={onPostInventory}
                            disabled={disabledToPost}
                        >
                            <CustomText style={buttonStyles(theme, typeTheme).buttonText}>
                                {createSellLoading ? <DotLoader /> : "Confirmar"}
                            </CustomText>
                        </TouchableOpacity>
                    </View>
                )
            }
        </SafeAreaView>
    ) : (
        <SafeAreaView style={ConfirmationScreenStyles(theme, typeTheme).ConfirmationScreen}>
            <View>
                <CustomText>Redireccionando sells...</CustomText>
            </View>
        </SafeAreaView>
    );
};